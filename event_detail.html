<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>活動詳情 - 校園社團活動管理系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
      min-height: 100vh;
    }
    .navbar {
      background: #4f8cff;
    }
    .navbar-brand, .nav-link, .navbar-text {
      color: #fff !important;
    }
    .event-detail-card {
      border-radius: 1.2rem;
      box-shadow: 0 2px 16px rgba(79,140,255,0.10);
      margin-top: 2rem;
      background: #fff;
    }
    .event-img {
      border-radius: 1.2rem 1.2rem 0 0;
      object-fit: cover;
      width: 100%;
      height: 260px;
    }
    .category-badge {
      background: #e0e7ff;
      color: #4f8cff;
      font-size: 0.95em;
      border-radius: 0.5rem;
      padding: 0.2em 0.7em;
      margin-right: 0.5em;
    }
    .comment-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      object-fit: cover;
      background: #e0e7ff;
      display: inline-block;
    }
    @media (max-width: 576px) {
      .event-img { height: 140px; }
      .event-detail-card { margin-top: 1rem; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg mb-4">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html"><i class="fa-solid fa-people-group me-2"></i>社團活動管理</a>
      <span class="navbar-text ms-auto"><i class="fa-solid fa-user-circle me-1"></i>student</span>
    </div>
  </nav>
  <div class="container">
    <div class="card event-detail-card mx-auto" style="max-width: 700px;">
      <img id="eventImg" class="event-img" src="" alt="活動圖片">
      <div class="card-body">
        <span class="category-badge" id="eventCategory"><i class="fa-solid fa-tag"></i></span>
        <span class="badge bg-light text-secondary ms-1" id="eventDate"><i class="fa-solid fa-calendar-day"></i></span>
        <h3 class="card-title mt-2" id="eventTitle"></h3>
        <p class="mb-1 text-muted"><i class="fa-solid fa-user-group me-1"></i><span id="eventOrganizer"></span></p>
        <p class="card-text" id="eventDesc"></p>
        <div class="d-flex align-items-center gap-2 mt-3">
          <button id="registerBtn" class="btn btn-primary"><i class="fa-solid fa-user-plus me-1"></i>報名參加</button>
          <button id="cancelBtn" class="btn btn-outline-danger d-none"><i class="fa-solid fa-xmark me-1"></i>取消報名</button>
          <span id="regStatus" class="ms-2"></span>
        </div>
      </div>
    </div>
    <div class="card mx-auto mt-4" style="max-width: 700px;">
      <div class="card-body">
        <h5 class="mb-3"><i class="fa-solid fa-comments me-2 text-primary"></i>留言討論</h5>
        <form id="commentForm" class="mb-3 d-flex gap-2">
          <img src="https://randomuser.me/api/portraits/men/32.jpg" class="comment-avatar" alt="avatar">
          <input type="text" class="form-control" id="commentInput" placeholder="輸入留言...">
          <button type="submit" class="btn btn-primary"><i class="fa-solid fa-paper-plane"></i></button>
        </form>
        <div id="commentsList">
          <!-- 留言將由 JS 動態產生 -->
        </div>
      </div>
    </div>
  </div>
  <script>
    // 取得活動 ID
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('id');
    const userId = 'your-user-id'; // 實際使用時應從登入狀態取得

    // 載入活動詳情
    fetch(`http://localhost:5000/api/event/${eventId}`)
      .then(res => res.json())
      .then(event => {
        if (!event.success) {
          document.querySelector('.event-detail-card').innerHTML = 
            '<div class="alert alert-danger m-3">找不到此活動</div>';
          return;
        }
        document.getElementById('eventImg').src = event.image || 'https://via.placeholder.com/700x260';
        document.getElementById('eventCategory').innerHTML = 
          `<i class="fa-solid fa-tag me-1"></i>${event.category}`;
        document.getElementById('eventDate').innerHTML = 
          `<i class="fa-solid fa-calendar-day me-1"></i>${event.date}`;
        document.getElementById('eventTitle').textContent = event.title;
        document.getElementById('eventOrganizer').textContent = event.organizer;
        document.getElementById('eventDesc').textContent = event.description;
        
        // 檢查報名狀態
        checkRegistration();
      })
      .catch(() => {
        document.querySelector('.event-detail-card').innerHTML = 
          '<div class="alert alert-danger m-3">載入活動資料失敗</div>';
      });

    // 檢查報名狀態
    function checkRegistration() {
      fetch(`http://localhost:5000/api/event/${eventId}/registrations?user_id=${userId}`)
        .then(res => res.json())
        .then(result => {
          const registerBtn = document.getElementById('registerBtn');
          const cancelBtn = document.getElementById('cancelBtn');
          if (result.length > 0) {
            registerBtn.classList.add('d-none');
            cancelBtn.classList.remove('d-none');
          } else {
            registerBtn.classList.remove('d-none');
            cancelBtn.classList.add('d-none');
          }
        });
    }

    // 報名活動
    document.getElementById('registerBtn').addEventListener('click', function() {
      fetch(`http://localhost:5000/api/event/${eventId}/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId })
      })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          document.getElementById('regStatus').innerHTML = 
            '<span class="text-success">報名成功！</span>';
          checkRegistration();
        } else {
          document.getElementById('regStatus').innerHTML = 
            `<span class="text-danger">${result.msg}</span>`;
        }
      });
    });

    // 取消報名
    document.getElementById('cancelBtn').addEventListener('click', function() {
      fetch(`http://localhost:5000/api/event/${eventId}/cancel`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId })
      })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          document.getElementById('regStatus').innerHTML = 
            '<span class="text-success">已取消報名</span>';
          checkRegistration();
        }
      });
    });

    // 載入留言
    function loadComments() {
      fetch(`http://localhost:5000/api/event/${eventId}/comments`)
        .then(res => res.json())
        .then(comments => {
          document.getElementById('commentsList').innerHTML = comments.map(comment => `
            <div class="d-flex gap-2 mb-3">
              <img src="https://randomuser.me/api/portraits/men/${Math.floor(Math.random() * 50)}.jpg" 
                class="comment-avatar" alt="avatar">
              <div>
                <div class="bg-light rounded-3 p-2">
                  <strong>${comment.user_id}</strong><br>
                  ${comment.content}
                </div>
                <small class="text-muted">${new Date(comment.created_at).toLocaleString()}</small>
              </div>
            </div>
          `).join('');
        });
    }

    // 發送留言
    document.getElementById('commentForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const content = document.getElementById('commentInput').value;
      if (!content) return;

      fetch(`http://localhost:5000/api/event/${eventId}/comment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: userId,
          content: content
        })
      })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          document.getElementById('commentInput').value = '';
          loadComments();
        }
      });
    });

    // 初始載入留言
    loadComments();
  </script>
</body>
</html>
